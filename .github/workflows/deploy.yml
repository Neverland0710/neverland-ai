name: Deploy Neverland AI to EC2

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  CONTAINER_NAME: neverland-ai
  IMAGE_NAME: neverland-ai
  APP_PORT: 8000

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: SSH & Deploy to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_KEY }}
        port: 22
        timeout: 600s
        command_timeout: 120s
        script: |
          set -e
          
          echo " Neverland AI ë°°í¬ ì‹œì‘..."
          echo " ì‹œì‘ ì‹œê°„: $(date)"
          
          # Docker ë²„ì „ í™•ì¸
          echo " Docker ë²„ì „ í™•ì¸:"
          docker --version
          
          # Git ì„¤ì • ì´ˆê¸°í™” (ì—ëŸ¬ ë°©ì§€)
          git config --global --unset-all core.sshCommand || true
          git config --global --unset-all http.https://github.com/.extraheader || true
          git config --global user.name "EC2 Deploy Bot" || true
          git config --global user.email "deploy@neverland.ai" || true
          
          # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ê´€ë¦¬
          PROJECT_DIR="$HOME/neverland-ai"
          
          # ê¸°ì¡´ ë””ë ‰í† ë¦¬ê°€ ìˆìœ¼ë©´ ì™„ì „íˆ ì‚­ì œí•˜ê³  ìƒˆë¡œ í´ë¡ 
          if [ -d "$PROJECT_DIR" ]; then
            echo " ê¸°ì¡´ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ì‚­ì œ ì¤‘..."
            rm -rf "$PROJECT_DIR"
          fi
          
          echo " ìƒˆ í”„ë¡œì íŠ¸ í´ë¡  ì¤‘..."
          git clone https://github.com/Neverland0710/neverland-ai.git "$PROJECT_DIR"
          cd "$PROJECT_DIR"
          
          echo " ì†ŒìŠ¤ì½”ë“œ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ"
          
          # í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„±
          echo " í™˜ê²½ë³€ìˆ˜ ì„¤ì • ì¤‘..."
          cat > .env << 'EOF'
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          QDRANT_URL=${{ secrets.QDRANT_URL }}
          QDRANT_API_KEY=${{ secrets.QDRANT_API_KEY }}
          DAILY_COLLECTION=${{ secrets.DAILY_COLLECTION }}
          LETTER_COLLECTION=${{ secrets.LETTER_COLLECTION }}
          OBJECT_COLLECTION=${{ secrets.OBJECT_COLLECTION }}
          MYSQL_HOST=${{ secrets.MYSQL_HOST }}
          MYSQL_PORT=${{ secrets.MYSQL_PORT }}
          MYSQL_USER=${{ secrets.MYSQL_USER }}
          MYSQL_PASSWORD=${{ secrets.MYSQL_PASSWORD }}
          MYSQL_DATABASE=${{ secrets.MYSQL_DATABASE }}
          ELEVENLABS_API_KEY=${{ secrets.ELEVENLABS_API_KEY }}
          LANGSMITH_API_KEY=${{ secrets.LANGSMITH_API_KEY }}
          LANGSMITH_ENDPOINT=${{ secrets.LANGSMITH_ENDPOINT }}
          LANGSMITH_PROJECT=${{ secrets.LANGSMITH_PROJECT }}
          ENVIRONMENT=production
          DEBUG=false
          LOG_LEVEL=INFO
          EOF
          
          chmod 600 .env
          echo " í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„± ì™„ë£Œ"
          
          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
          echo "ğŸ§¹ ê¸°ì¡´ ì„œë¹„ìŠ¤ ì •ë¦¬ ì¤‘..."
          
          # ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ ê°•ì œ ì¢…ë£Œ
          if docker ps -q --filter "name=${{ env.CONTAINER_NAME }}" | grep -q .; then
            echo "ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ê°•ì œ ì¢…ë£Œ ì¤‘..."
            docker kill ${{ env.CONTAINER_NAME }} || true
            sleep 3
          fi
          
          # ì»¨í…Œì´ë„ˆ ì‚­ì œ
          docker rm -f ${{ env.CONTAINER_NAME }} || true
          
          # ê¸°ì¡´ ì´ë¯¸ì§€ ì‚­ì œ
          docker rmi -f ${{ env.IMAGE_NAME }} || true
          
          # Docker ì‹œìŠ¤í…œ ì •ë¦¬
          docker system prune -f || true
          
          echo " ê¸°ì¡´ ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ì™„ë£Œ"
          
          # Dockerfile ì¡´ì¬ í™•ì¸
          if [ ! -f "Dockerfile" ]; then
            echo " Dockerfileì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!"
            echo "í˜„ì¬ ë””ë ‰í† ë¦¬ ë‚´ìš©:"
            ls -la
            exit 1
          fi
          
          echo " Dockerfile í™•ì¸ ì™„ë£Œ"
          
          # Docker ë²„ì „ë³„ ë¹Œë“œ ëª…ë ¹ì–´ ì„ íƒ
          DOCKER_VERSION=$(docker --version | grep -oE '[0-9]+\.[0-9]+' | head -1)
          MAJOR_VERSION=$(echo $DOCKER_VERSION | cut -d. -f1)
          MINOR_VERSION=$(echo $DOCKER_VERSION | cut -d. -f2)
          
          echo " Docker ë²„ì „: $DOCKER_VERSION (Major: $MAJOR_VERSION, Minor: $MINOR_VERSION)"
          
          # Docker ì´ë¯¸ì§€ ë¹Œë“œ (êµ¬ë²„ì „ í˜¸í™˜)
          echo " Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
          
          # BuildKit ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸ í›„ ë¹Œë“œ
          if docker buildx version > /dev/null 2>&1; then
            echo "BuildKit ì‚¬ìš© ê°€ëŠ¥ - ìµœì‹  ë¹Œë“œ ë°©ì‹ ì‚¬ìš©"
            docker buildx build -t ${{ env.IMAGE_NAME }} . --load
          else
            echo "ë ˆê±°ì‹œ Docker ë¹Œë“œ ì‚¬ìš©"
            docker build -t ${{ env.IMAGE_NAME }} . --no-cache
          fi
          
          if [ $? -ne 0 ]; then
            echo " Docker ì´ë¯¸ì§€ ë¹Œë“œ ì‹¤íŒ¨"
            echo "Docker ë¹Œë“œ ë¡œê·¸ í™•ì¸ì„ ìœ„í•´ ë‹¤ì‹œ ì‹œë„..."
            docker build -t ${{ env.IMAGE_NAME }} .
            exit 1
          fi
          
          echo " Docker ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ"
          
          # ë¹Œë“œëœ ì´ë¯¸ì§€ í™•ì¸
          echo " ë¹Œë“œëœ ì´ë¯¸ì§€ ì •ë³´:"
          docker images | grep ${{ env.IMAGE_NAME }} || true
          
          # ì»¨í…Œì´ë„ˆ ì‹¤í–‰
          echo " ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œì‘ ì¤‘..."
          docker run -d \
            -p ${{ env.APP_PORT }}:${{ env.APP_PORT }} \
            --env-file .env \
            --restart unless-stopped \
            --name ${{ env.CONTAINER_NAME }} \
            --memory=2g \
            --cpus=1.0 \
            ${{ env.IMAGE_NAME }}
          
          if [ $? -ne 0 ]; then
            echo " ì»¨í…Œì´ë„ˆ ì‹œì‘ ì‹¤íŒ¨"
            echo "Docker ë¡œê·¸ í™•ì¸:"
            docker logs ${{ env.CONTAINER_NAME }} || true
            exit 1
          fi
          
          echo " ì»¨í…Œì´ë„ˆ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
          sleep 20
          
          # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
          echo " ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸ ì¤‘..."
          if ! docker ps --filter name=${{ env.CONTAINER_NAME }} --filter status=running -q | grep -q .; then
            echo " ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤"
            echo "ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
            docker ps -a --filter name=${{ env.CONTAINER_NAME }}
            echo ""
            echo "ì»¨í…Œì´ë„ˆ ë¡œê·¸:"
            docker logs ${{ env.CONTAINER_NAME }} || true
            echo ""
            echo "ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ í™•ì¸:"
            free -h
            df -h
            exit 1
          fi
          
          echo " ì»¨í…Œì´ë„ˆê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤"
          
          # í¬íŠ¸ í—¬ìŠ¤ì²´í¬
          echo " ì„œë¹„ìŠ¤ í—¬ìŠ¤ì²´í¬ ì¤‘..."
          for i in {1..30}; do
            echo "í—¬ìŠ¤ì²´í¬ ì‹œë„ $i/30..."
            
            # í¬íŠ¸ í™•ì¸ (ì—¬ëŸ¬ ë°©ë²• ì‹œë„)
            if netstat -tuln 2>/dev/null | grep :${{ env.APP_PORT }} > /dev/null; then
              echo " í¬íŠ¸ ${{ env.APP_PORT }}ì—ì„œ ì„œë¹„ìŠ¤ê°€ ì •ìƒ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤!"
              break
            elif ss -tuln 2>/dev/null | grep :${{ env.APP_PORT }} > /dev/null; then
              echo " í¬íŠ¸ ${{ env.APP_PORT }}ì—ì„œ ì„œë¹„ìŠ¤ê°€ ì •ìƒ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤!"
              break
            elif docker port ${{ env.CONTAINER_NAME }} 2>/dev/null | grep -q ${{ env.APP_PORT }}; then
              echo " Docker í¬íŠ¸ ë§¤í•‘ì´ ì •ìƒì…ë‹ˆë‹¤!"
              break
            fi
            
            if [ $i -eq 30 ]; then
              echo " í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ - í¬íŠ¸ê°€ ì—´ë¦¬ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
              echo ""
              echo " ë””ë²„ê¹… ì •ë³´:"
              echo "ì»¨í…Œì´ë„ˆ í¬íŠ¸ ì •ë³´:"
              docker port ${{ env.CONTAINER_NAME }} || true
              echo ""
              echo "ë„¤íŠ¸ì›Œí¬ ìƒíƒœ:"
              netstat -tuln | grep ${{ env.APP_PORT }} || echo "netstatì—ì„œ í¬íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ"
              ss -tuln | grep ${{ env.APP_PORT }} || echo "ssì—ì„œ í¬íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ"
              echo ""
              echo "ì»¨í…Œì´ë„ˆ ë¡œê·¸ (ë§ˆì§€ë§‰ 50ì¤„):"
              docker logs ${{ env.CONTAINER_NAME }} --tail 50
              exit 1
            fi
            
            sleep 3
          done
          
          # API í…ŒìŠ¤íŠ¸ (curlì´ ì„¤ì¹˜ë˜ì–´ ìˆë‹¤ë©´)
          if command -v curl > /dev/null 2>&1; then
            echo " API ì‘ë‹µ í…ŒìŠ¤íŠ¸ ì¤‘..."
            sleep 5  # ì¶”ê°€ ëŒ€ê¸°
            
            if curl -f --connect-timeout 10 --max-time 30 http://localhost:${{ env.APP_PORT }}/health > /dev/null 2>&1; then
              echo " API í—¬ìŠ¤ì²´í¬ ì„±ê³µ!"
            elif curl -f --connect-timeout 10 --max-time 30 http://localhost:${{ env.APP_PORT }}/ > /dev/null 2>&1; then
              echo " ê¸°ë³¸ ì—”ë“œí¬ì¸íŠ¸ ì ‘ê·¼ ì„±ê³µ!"
            else
              echo " API í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ (ì„œë¹„ìŠ¤ëŠ” ì‹¤í–‰ ì¤‘ì¼ ìˆ˜ ìˆìŒ)"
              echo "ìˆ˜ë™ìœ¼ë¡œ http://${{ secrets.EC2_HOST }}:${{ env.APP_PORT }} í™•ì¸ í•„ìš”"
            fi
          else
            echo " curlì´ ì„¤ì¹˜ë˜ì§€ ì•ŠìŒ - API í…ŒìŠ¤íŠ¸ ê±´ë„ˆëœ€"
          fi
          
          # ë°°í¬ ì™„ë£Œ ì •ë³´
          echo ""
          echo " ë°°í¬ ì™„ë£Œ!"
          echo " ì™„ë£Œ ì‹œê°„: $(date)"
          echo ""
          echo " ì„œë¹„ìŠ¤ ì •ë³´:"
          echo " ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
          docker ps --filter name=${{ env.CONTAINER_NAME }} --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" || true
          echo ""
          echo " ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰:"
          docker stats ${{ env.CONTAINER_NAME }} --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}" || true
          echo ""
          echo " ì„œë¹„ìŠ¤ ì ‘ì† ì •ë³´:"
          echo "   - ë‚´ë¶€: http://localhost:${{ env.APP_PORT }}"
          echo "   - ì™¸ë¶€: http://${{ secrets.EC2_HOST }}:${{ env.APP_PORT }}"
          echo ""
          echo " Neverland AIê°€ ì •ìƒì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤!"

    - name: Deployment Result
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo " ë°°í¬ ì„±ê³µ!"
          echo " Neverland AIê°€ EC2ì—ì„œ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤."
          echo " ì„œë¹„ìŠ¤ URL: http://${{ secrets.EC2_HOST }}:8000"
        else
          echo " ë°°í¬ ì‹¤íŒ¨!"